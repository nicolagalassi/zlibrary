<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZuLibrary</title>
  <link rel="icon" href="img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="src/output.css">
  <script defer src="https://cloud.umami.is/script.js" data-website-id="ecfe38f9-d4f7-4dc3-9138-6901aa3e4ed9"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://unpkg.com/imask"></script>  
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans min-h-screen flex flex-col">
  <header class="bg-white dark:bg-gray-800 shadow p-4 sticky top-0 z-10">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
        <a href="index.html" class="flex items-center gap-2 text-2xl font-bold text-gray-700 dark:text-gray-200">
            <i class="fa-solid fa-book text-blue-500"></i>
            ZuLibrary
        </a>
        <div class="flex items-center gap-4">
            <a title="Home" href="index.html" class="flex items-center gap-1 text-sm text-gray-700 dark:text-gray-200 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 bg-gray-100 dark:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                </svg>
            </a>
            <a title="Elenco" href="elenco.html" class="flex items-center gap-1 text-sm text-gray-700 dark:text-gray-200 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>
            </a>
            <button id="theme-toggle" title="Cambia Tema" class="flex items-center gap-1 text-sm text-gray-700 dark:text-gray-200 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 block dark:hidden">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"/>
                </svg>
                <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 hidden dark:block">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"/>
                </svg>
            </button>
        </div>
    </div>
</header>

  <div id="news-banner"
  data-banner-version="0.7" class="bg-gradient-to-r from-cyan-100 to-blue-100 dark:from-cyan-900 dark:to-blue-900 border-b border-cyan-200 dark:border-blue-800 p-3 relative text-sm text-gray-800 dark:text-gray-200 shadow">
<div class="max-w-4xl mx-auto flex justify-between items-center gap-4">
 <p class="flex-grow text-center">
    <i class="fa-solid fa-circle-info mr-2 text-blue-600 dark:text-blue-400"></i>
    <span class="font-semibold">Novità V0.7:</span> Aggiunti i sommari di CU770.
    <span class="hidden md:inline">Scoprili nella sezione <a href="elenco.html" class="underline font-semibold hover:text-blue-600 dark:hover:text-blue-400">Elenco</a>!</span>
  </p>
 <button id="close-banner-button" title="Chiudi banner" class="text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
     <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
   </svg>
 </button>
</div>
</div>

  <main class="flex-grow flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-700 shadow-lg rounded-lg p-6 w-full max-w-md">
      <h2 class="text-xl font-semibold mb-4 text-center">Scarica un sommario che non trovi</h2>
      <p class="text-center text-sm text-gray-500 dark:text-gray-400 mb-4">
        Da oggi puoi scaricare i sommari di nuovi applicativi.
      </p>
     <form id="form" novalidate> <label for="applicativo" class="block text-sm mb-2">Applicativo:</label>
      <select id="applicativo" name="applicativo" class="w-full p-2 border outline-1 -outline-offset-1 outline-gray-300 dark:outline-gray-600 border-gray-300 dark:border-gray-600 rounded mb-4 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus-within:outline-2 focus-within:-outline-offset-2 focus-within:outline-blue-400">
        <option value="HR1" selected>Paghe Infinity </option>
        <option value="ERM">Portale HR</option>
        <option value="MD7">CU770</option>
        <option value="HRC">HR Comunicazioni</option>
        <option value="DWH">HR Analytics</option>
      </select>
        <label for="versione" class="block text-sm mb-2">Versione Master:</label>
      <input
        type="text"
        id="versione"
        name="versione"
        required
        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded mb-4 outline-1 -outline-offset-1 outline-gray-300 dark:outline-gray-600 focus-within:outline-2 focus-within:-outline-offset-2 focus-within:outline-blue-400"
        maxlength="8" placeholder="Es. 25.04.00"
        aria-describedby="errore-versione" />
       <p id="errore-versione" class="text-red-600 text-sm -mt-2 mb-4 hidden"></p> <label for="upd" class="block text-sm mb-2">Numero Patch (UPD):</label>
      <input
        type="text"
        id="upd"
        name="upd"
        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded mb-4 outline-1 -outline-offset-1 outline-gray-300 dark:outline-gray-600 focus-within:outline-2 focus-within:-outline-offset-2 focus-within:outline-blue-400"
        placeholder="Lascia vuoto per 000"
        maxlength="3" aria-describedby="errore-upd" />
        <p id="errore-upd" class="text-red-600 text-sm -mt-2 mb-4 hidden"></p> <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">
        Scarica PDF
      </button>
    </form>
    <p id="errore-submit" class="text-red-600 text-sm mt-4 hidden">Si è verificato un errore.</p>

    </div>
  </main>

  <footer class="bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-sm border-t border-gray-300 dark:border-gray-700">
    <div class="max-w-4xl mx-auto py-6 px-4 text-center space-y-4"> <nav class="flex justify-center gap-x-6 gap-y-2 flex-wrap" aria-label="Navigazione piè di pagina">
        <a href="index.html" class="hover:text-gray-900 dark:hover:text-gray-100 hover:underline">Home</a>
        <a href="about.html" class="hover:text-gray-900 dark:hover:text-gray-100 hover:underline">About & Changelog</a>
        <a href="privacy.html" class="hover:text-gray-900 dark:hover:text-gray-100 hover:underline">Privacy Policy</a>
        </nav>
  
      <p class="text-xs text-gray-500 dark:text-gray-500 px-4"> ZuLibrary è uno strumento non ufficiale e non è affiliato in alcun modo con Zucchetti S.p.a.
      </p>
  
      <p class="text-xs">
        &copy; <span id="current-year">2025</span> ZuLibrary <span class="text-gray-400 dark:text-gray-600 mx-1">|</span> <span>Versione alpha_0.7.0</span> </p>
  
    </div>
  </footer>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const yearSpan = document.getElementById('current-year');
      if (yearSpan) {
        yearSpan.textContent = new Date().getFullYear();
      }
      // Assicurati che altro codice JS che deve aspettare il DOM sia qui dentro o dopo
    });
  </script>

<script>
  document.addEventListener('DOMContentLoaded', (event) => {

    // Aggiungi questo DENTRO il DOMContentLoaded listener
    // --- Logica Banner Novità (con Versioning) ---
const newsBanner = document.getElementById('news-banner');
const closeBannerButton = document.getElementById('close-banner-button');

if (newsBanner && closeBannerButton) {
  const currentBannerVersion = newsBanner.dataset.bannerVersion; // Leggi la versione dall'attributo data-*
  const dismissedBannerVersion = localStorage.getItem('dismissedBannerVersion'); // Leggi la versione chiusa salvata

  // Controlla se la versione CORRENTE è la STESSA di quella già chiusa
  if (currentBannerVersion && currentBannerVersion === dismissedBannerVersion) {
    newsBanner.classList.add('hidden'); // Nascondilo solo se QUESTA versione è già stata chiusa
    console.log(`Banner versione ${currentBannerVersion} già chiuso in passato.`); // Debug
  } else {
     newsBanner.classList.remove('hidden'); // Altrimenti mostralo (o assicurati sia visibile)
     console.log(`Mostro banner versione ${currentBannerVersion}. (Versione chiusa: ${dismissedBannerVersion})`); // Debug
  }

  // Aggiungi l'evento per chiudere il banner al click sul pulsante
  closeBannerButton.addEventListener('click', () => {
    const versionToDismiss = newsBanner.dataset.bannerVersion; // Prendi la versione CORRENTE al momento del click
    if (versionToDismiss) {
        newsBanner.classList.add('hidden'); // Nascondi il banner
        localStorage.setItem('dismissedBannerVersion', versionToDismiss); // Memorizza la versione specifica che è stata chiusa
        console.log(`Banner versione ${versionToDismiss} chiuso e versione salvata.`); // Debug
    } else {
        // Fallback se manca la versione (nascondi comunque ma non salvare la versione)
         newsBanner.classList.add('hidden');
         console.warn("Attributo data-banner-version mancante sul banner. Banner nascosto ma versione non salvata.");
    }
  });
} else {
    console.warn("Elementi del banner novità non trovati (#news-banner o #close-banner-button)");
}
// Fine Logica Banner Novità ---
    
    // Metti tutto il codice che interagisce con il DOM qui dentro

    // Elementi del DOM
    const form = document.getElementById('form');
    const applicativoSelect = document.getElementById('applicativo');
    const versioneInput = document.getElementById('versione');
    const updInput = document.getElementById('upd');
    const erroreVersioneP = document.getElementById('errore-versione');
    const erroreUpdP = document.getElementById('errore-upd');
    const erroreSubmitP = document.getElementById('errore-submit');
    const themeToggleButton = document.getElementById('theme-toggle');
    const htmlElement = document.documentElement;

    // --- Funzioni di Validazione ---
    function validaVersione(versione) {
      const regex = /^\d{2}\.\d{2}\.\d{2}$/;
      return regex.test(versione);
    }

    function validaUpd(upd) {
      return upd === '' || /^\d{3}$/.test(upd);
    }

    // --- Inizializzazione Maschera per Versione ---
    let versioneMaskInstance = null;
    if (versioneInput) {
      try {
        versioneMaskInstance = IMask(versioneInput, {
          mask: '00.00.00' // Opzione 'lazy' rimossa (usa default true)
        });
        console.log("IMask inizializzata per #versione (lazy: default)");
      } catch (error) {
          console.error("Errore durante l'inizializzazione di IMask:", error);
          if(erroreSubmitP) {
            erroreSubmitP.textContent = "Errore nell'attivazione maschera input.";
            erroreSubmitP.classList.remove('hidden');
          }
      }
    } else {
        console.error("Elemento #versione non trovato per IMask.");
    }


    // --- Gestore Submit del Form ---
    if(form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();

        // Nascondi errori precedenti e stili (tranne quelli da blur)
        // Li rivaluteremo comunque
        if(erroreSubmitP) erroreSubmitP.classList.add('hidden');

        // Ottieni valori
        const app = applicativoSelect ? applicativoSelect.value.trim() : '';
        const versione = versioneInput ? versioneInput.value.trim() : '';
        const upd = updInput ? updInput.value.trim() : '';

        // Esegui Validazione (usando le funzioni onblur che aggiornano UI)
        let isVersioneValid = true;
        let isUpdValid = true;

        // Simula blur per forzare validazione e UI update anche se l'utente non ha lasciato il campo
        if (versioneInput) versioneInput.dispatchEvent(new Event('blur'));
        if (updInput) updInput.dispatchEvent(new Event('blur'));

        // Ricontrolla validità dopo blur simulato
        isVersioneValid = versione && validaVersione(versione);
        isUpdValid = validaUpd(upd); // upd può essere vuoto

        // Se non valido, interrompi (gli errori sono già mostrati da blur)
        if (!isVersioneValid || !isUpdValid) {
          // Assicurati che il focus vada al primo campo errato
           if (!isVersioneValid && versioneInput) {
               versioneInput.focus();
           } else if (!isUpdValid && updInput) {
               updInput.focus();
           }
          return;
        }

        // Se valido, procedi
        const updFinale = upd || '000';
        const nomeFile = `${app}_${versione}_${updFinale}.pdf`;
        const url = `https://www.hrzucchetti.it/infoupdate/${app}/${nomeFile}`;

        try {
          window.open(url, '_blank');
        } catch (error) {
          console.error("Errore apertura finestra:", error);
           if(erroreSubmitP) {
              erroreSubmitP.textContent = "Impossibile aprire la nuova scheda. Verifica le impostazioni del browser.";
              erroreSubmitP.classList.remove('hidden');
          }
        }
      });
    } else {
        console.error("Elemento #form non trovato.");
    }


    // --- Logica Toggle Tema (Aggiornata con Preferenza Sistema) ---


    if (themeToggleButton && htmlElement) {

        // Funzione helper per applicare il tema (aggiunge/rimuove la classe 'dark')
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                console.log("Applicato tema: dark"); // Debug
            } else {
                htmlElement.classList.remove('dark');
                console.log("Applicato tema: light"); // Debug
            }
            // Qui potresti aggiungere logica per cambiare l'icona del sole/luna se necessario
        };

        // Funzione per determinare e applicare il tema iniziale
        const initializeTheme = () => {
            const savedTheme = localStorage.getItem('theme'); // Tema salvato manualmente?
            let initialTheme = 'light'; // Default a light

            if (savedTheme) {
                // 1. Priorità: Tema salvato manualmente dall'utente
                initialTheme = savedTheme;
                console.log(`Trovato tema salvato: ${initialTheme}`); // Debug
            } else {
                // 2. Nessun tema salvato: Controlla preferenza di sistema
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    initialTheme = 'dark';
                }
                // else initialTheme rimane 'light'
                console.log(`Nessun tema salvato, uso tema di sistema: ${initialTheme}`); // Debug
            }
            applyTheme(initialTheme);
        };

        // Aggiungi l'event listener al pulsante di toggle
        themeToggleButton.addEventListener('click', () => {
            // Determina quale sarà il NUOVO tema DOPO il click
            const isCurrentlyDark = htmlElement.classList.contains('dark');
            const newTheme = isCurrentlyDark ? 'light' : 'dark';

            // Applica il nuovo tema visivamente
            applyTheme(newTheme);

            // Salva la scelta MANUALE nel localStorage, sovrascrivendo quella di sistema
            localStorage.setItem('theme', newTheme);
            console.log(`Tema cambiato manualmente e salvato: ${newTheme}`); // Debug
        });

        // Imposta il tema iniziale al caricamento dello script
        initializeTheme();

        // Bonus: Ascolta i cambiamenti del tema di sistema MENTRE la pagina è aperta
        // Aggiorna il tema SOLO SE l'utente NON ha fatto una scelta manuale
        try {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                const savedTheme = localStorage.getItem('theme');
                if (!savedTheme) { // Cambia solo se non c'è una scelta manuale salvata
                    const newSystemTheme = event.matches ? 'dark' : 'light';
                    console.log(`Tema di sistema cambiato in ${newSystemTheme} (applicato perché non c'è scelta manuale)`); // Debug
                    applyTheme(newSystemTheme);
                } else {
                    console.log("Tema di sistema cambiato, ma ignorato perché esiste una scelta manuale salvata."); // Debug
                }
            });
        } catch (e) {
            console.error("Errore nell'aggiungere listener per cambio tema di sistema:", e);
        }


    } else {
        console.error("Elemento #theme-toggle o <html> non trovato per la logica del tema.");
    }
    // --- Fine Logica Toggle Tema ---


    // --- Validazione on Blur (RIATTIVATA E MIGLIORATA) ---
    if (versioneInput) {
        versioneInput.addEventListener('blur', () => {
          const versione = versioneInput.value.trim();
          if (!versione) { // Campo obbligatorio lasciato vuoto
             if(erroreVersioneP) {
                  erroreVersioneP.textContent = 'Campo obbligatorio. Formato: ##.##.##.';
                  erroreVersioneP.classList.remove('hidden');
             }
             versioneInput.classList.add('border-red-500');
          } else if (!validaVersione(versione)) { // Contenuto presente ma non valido
             if(erroreVersioneP) {
                  erroreVersioneP.textContent = 'Formato non valido. Usa ##.##.##.';
                  erroreVersioneP.classList.remove('hidden');
             }
             versioneInput.classList.add('border-red-500');
          } else { // Valido
             if(erroreVersioneP) erroreVersioneP.classList.add('hidden');
             versioneInput.classList.remove('border-red-500');
          }
        });
    }

    if (updInput) {
        updInput.addEventListener('blur', () => {
            const upd = updInput.value.trim();
            // Mostra errore solo se c'è contenuto E NON è valido
            if (upd && !validaUpd(upd)) {
                if(erroreUpdP) {
                  erroreUpdP.textContent = 'Formato non valido. Usa ###.';
                  erroreUpdP.classList.remove('hidden');
                }
               updInput.classList.add('border-red-500');
            } else { // Vuoto o valido
               if(erroreUpdP) erroreUpdP.classList.add('hidden');
               updInput.classList.remove('border-red-500');
            }
        });
    }

  }); // Fine DOMContentLoaded
</script>

</body>
</html>